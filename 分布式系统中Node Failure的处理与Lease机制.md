---
title: 分布式系统中Node Failure的处理与Lease机制
tags: 
grammar_cjkRuby: true
---
# Node Failure
有两种情况可以从PCS端视角视为Node Failure:
1. 网络故障
2. 主机crash


# Lease
lease(租约)就是一种合约，一个授予者颁发被授予者一个lease，表示一项承诺：在某个期限内，被授予者拥有某项权力。


# 问题
## lease机制怎么检测并处理Node Failure
由于lease(租约)拥有“期限”，可以非常好的容错网络异常。
当“租期”内网络出现分区、异常，在“租期”内仍然不会影响进程的正常工作，只是不能进行“续租”而已，如果网络能在“租期”耗尽前恢复，使得被授予者能够在租期内成功续约，则不会产生任何异常。

由于lease(租约)能够自动释放，可以很好的容错宕机问题。
当获得lease(租约)的节点宕机后，“租期”耗尽时，自动释放，使得其他节点能够重新获取lease(租约)。


### 谁颁发lease，承诺是什么
PCS给各node颁发lease，并承诺“在有效租期内，该节点是正常节点”


### lease的期限选多长？
如果 lease 的时长太短，一旦出现网络抖动 lease 很容易丢失，从而造成节点失去 lease，使得依赖 lease 的服务停止；
如果 lease 的时长太大，则一旦接受者异常，颁发者需要过长的时间收回 lease 承诺。

使用 lease 确定节点状态时，若 lease 时间过短，有可能造成网络瞬断时节点收不到 lease 从而引起服务不稳定
若 lease 时间过长，则一旦某节点宕机异常，需要较大的时间等待 lease 过期才能发现节点异常。

### lease中时间同步问题
lease机制中，PCS与各节点都在各自的单调时钟下判断时间，怎么处理基准时间不同步的问题？

##  PCS发生主从切换，lease数据怎么处理



# 其他系统使用lease机制的情况
Google 的 chubby 服务实现了类似的基于时间限制的租约机制。
zookeeper 的会话管理采用了类似于复制租约的机制。
Kafka 的 kip-631 提出使用有时间限制的租约，对分组成员信息进行管理。
etcd 提供了有时间限制的租约设施，客户端可以用其协调其活动，以及分组成员信息和失效检测。