---
title: PostDB - redo日志空洞管理模块设计
tags: WAL 
category: /小书匠/日记/2021-07
renderNumberedHeading: true
grammar_cjkRuby: true
---


# 功能
### 总体功能

![绘图](./attachments/1626283921116.drawio.html)



### 页区间合并与空洞发现
###### 页存储状态列表
- 列表记录了所有已完成持久化的数据页(page)的状态
- 每个列表item包含如下信息：first_page_lsn, range_type, last_record_lsn
	- first_page_lsn：连续区域里最后一个page的lsn
	- range_type：区间内是空洞/非空洞
	- last_record_lsn：区间内最后一个record的lsn。此字段只在page区间有效。
	- hole_range_sent：空洞区间是否已发送给空洞填充service。此字段只在hole区间有效。
- 区间的表示：[item1.first_page_lsn, item2.first_page_lsn)

- 在系统初始化时，创建页存储列表
- 在系统正常退出时，保存页存储列表至硬盘系统配置
- 在系统recovery时，恢复页存储列表。具体恢复流程见异常处理
- 主模块调用本模块时，会传递已持久化的区间[first_page_lsn, last_page_lsn]信息过来，本模块负责将其合并到页存储状态列表

###### 页区间合并

- 算法

![绘图](./attachments/1627628363001.drawio.html)

- 已有空洞与新空洞
	- 在持续的空洞扫描过程中，原有空洞可能会出现部分被填充，继而分裂为两个空洞。这种重叠的空洞，在向其他peer寻求数据的时候，注意不要重复请求。

###### 空洞发现
- 算法

![绘图](./attachments/1627873970845.drawio.html)

- 不要重复请求同一空洞区间
	- 页存储状态必须保证：所有已经发送到空洞填充service的空洞区间，状态是正确的（“已发送”状态）；特别是空洞区间被部分填充的场景下，注意细节
	- 

### 空洞填充
###### 请求状态列表
- 列表记录了所有需要向其他peer请求数据的空洞区间及请求状态
- 每个列表item包含如下信息：
	- hole_range - 空洞区间
	- requested - 是否已经请求
	- last_request_time - 上次请求时间
- 列表数据加入：空洞发现service在发现空洞后，通过channel发送到空洞填充service，然后加入到列表中
- 列表数据删除：当从peer收到某区间数据时，删除列表中对应区间的item
  
###### 请求数据
- 流程

![绘图](./attachments/1626068651977.drawio.html)

- 数据寻址
  - 随机选择peer，进行数据查找

- 获取数据
	- 向上述peer发送请求(空洞区间)，获取数据；更新请求列表
	
- 超时重传	- 如果获取数据请求超时没有得到回复，则考虑peer disabled的可能性；重新随机选择peer，并发送数据

###### 数据填充

![绘图](./attachments/1627887572129.drawio.html)

- 填充空洞数据
	- 调用既有接口，将空洞数据填充到日志持久化存储中
	- 填充之前先判断存储区块列表中是否包含相应区间，包含则说明已填充完毕，无需再填充

### 异常处理
###### 主机宕机
主机宕机有可能造成存储区间列表不能正常退出序列化，从而影响重启后正常的功能。因此需要重新构建存储区间列表
- 流程

![绘图](./attachments/1626285222578.drawio.html)

- 从持久化日志存储中重构存储区间列表
  - 从NCL开始读取日志record，一直读到最新(???遇到最后一条记录就不读了)
  - 判断record->prev是否与前一个record的lsn相等。若不相等，则存在空洞
  - 最终重构出与当前日志相匹配的存储区间列表
  - recovery时，系统会发送一个truncate命令给我，我需要提供一个接口，把lsn后面的区间全部清除

###### 网络故障
- 本模块在进行空洞填充时会通过网络发送接受日志数据
- 发生网络故障时，比如网络中断/网络超时等，目前会延迟空洞填充补齐的时间，并不影响系统的功能性和健壮性。

### 接口
###### 与主模块的接口
- 调用
	- 写page数据 - 在空洞填充时调用
	- page数据获取 - 指定page区间，从本地取得指定数据
- 被调用
	- 空洞管理
		   - 建立page页信息
		   - page页信息管理：索引，合并，排序
		   - 空洞发现 - 扫描SGCL（含）以下的page页信息，发送空洞信息给数据请求服务

###### 与其他模块的接口
- 无

