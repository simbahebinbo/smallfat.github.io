---
title: 并行回放调研
tags: 回放 并行
category: /小书匠/日记/2022-07
grammar_cjkRuby: true
---
# 背景
# 思路
### 执行单元
- 多个执行单元同时进行xlog回放

### 回放策略
- 依据对xlog的record类别不同，采用不同的回放组织策略
	- 事务日志
		- 为属于事务日志的xlog，放入一个有序队列，并分配一个回放执行单元
		- 队列按照xlog recored原顺序排序
	- DML日志 
		- 为属于同一个table的records，放入一个有序队列，并分配一个回放执行单元
		- 队列按照xlog record原顺序排序
		- 在相应开始事务日志(start)执行了以后，再来执行该事务下所有不同table下的XLOG回放，直到某条record的下一个同事务record是结束事务日志(commit/rollback)
	- DDL日志
		- 是否需要考虑与相应DDL的前后关系问题？-


# 目标
- 目前postdb v3是串行回放xlog，希望能实现并行回放，且在回放完成后能够保证数据的一致性
- 在并行回放的过程中中断回放，亦需要保证page buffer中数据的完整性和一致性

# 关联因素
- xlog的结构
- xlog record的类型
- NRL
	- 由于并行回放是非单一连续回放，NRL可能需要重新考虑其意义
- PGCL
- 事务的ACID
- 回放时的事务控制策略
	- 并行/串行？
	- 串行/并行回放时，事务的ACID分别如何保证？
		- 为了保证事务的ACID，回放时的sql动作执行顺序是否要与写入时完全一致？
			- 类型1：每个sql动作的全序顺序一致
			- 类型2：每个事务内的sql动作顺序一致

# 并行回放要解决的一些问题
- 数据写入顺序的考虑
	- 串行回放xlog record，数据写入到page buffer的先后顺序，与在计算节点写入page buffer的顺序是严格一致的
	- 那么，并行回放时，上述顺序的关系应该是怎么样的呢？
- 事务与回放的关系
- 事务隔离性
